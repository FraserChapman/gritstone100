<!DOCTYPE html>
<html>
<head>
	<title>leaflet-elevation.js</title>
	<meta http-equiv='Content-Type' content='text/html; charset=UTF-8'>
	<meta name='viewport' content='initial-scale=1.0, user-scalable=no' />
	<style>
		html,
		body,
		#map,
		#elevation-div {
			height: 100%;
			width: 100%;
			padding: 0px;
			margin: 0px;
		}
	</style>
	<script src='https://d3js.org/d3.v4.js' charset='utf-8'></script>
	<!-- Leaflet (JS/CSS) -->
	<link rel='stylesheet' href='https://unpkg.com/leaflet@1.3.2/dist/leaflet.css' />
	<script src='https://unpkg.com/leaflet@1.3.2/dist/leaflet.js'></script>
	<!-- D3.js -->
	<script src='https://unpkg.com/d3@4.13.0/build/d3.min.js' charset='utf-8'></script>
	<!-- leaflet-gpx -->
	<script src='https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.4.0/gpx.js'></script>
	<!-- leaflet-elevation -->
	<link rel='stylesheet' href='https://unpkg.com/@raruto/leaflet-elevation@0.3.9/leaflet-elevation.min.css' />
	<script src='https://unpkg.com/@raruto/leaflet-elevation@0.3.9/leaflet-elevation.min.js'></script>
    <!-- os -->
    <link rel="stylesheet" href="https://labs.os.uk/public/os-api-branding/v0.2.0/os-api-branding.css" />
    <script src="https://labs.os.uk/public/os-api-branding/v0.2.0/os-api-branding.js"></script>
    <!-- mapbox-gl -->
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/v1.13.1/mapbox-gl.css'/>
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v1.13.1/mapbox-gl.js"></script>
    <script src="https://unpkg.com/mapbox-gl-leaflet/leaflet-mapbox-gl.js"></script>
	<style>
		.height-focus.line,
		.height-focus-label {
			display: none;
		}
		.height-focus.circle-lower {
			stroke: white;
			fill: black;
			stroke-width: 3px;
			-webkit-filter: drop-shadow(0 0 5px #000);
			filter: drop-shadow(0 0 5px #000);
		}
		.elevation.leaflet-control {
			margin-bottom: 17.5px;
		}
        #map {
            height: 75%;
        }
        #elevation-div {
            height: 25%;
            font: 12px/1.5 'Helvetica Neue', Arial, Helvetica, sans-serif;
        }
		.gpx-summary {
			font-family: 'Lucida Grande', 'Lucida Sans Unicode', Verdana, Arial, Helvetica, sans-serif;
			font-size: 13px;
			position: absolute;
			bottom: 0;
			z-index: 1000;
			background: rgba(255, 255, 255, 0.8);
			margin: 0 10px;
			max-width: 600px;
			left: 0;
			right: 0;
			text-align: center;
		}
		.gpx-summary .summaryvalue {
			font-weight: bold;
		}
	</style>
</head>

<body>
	<div id='map'></div>
    <div id='elevation-div' class='leaflet-control elevation'></div>
	<div id='gpx-summary' class='gpx-summary'>
        <span class='totlen'>
            <span class='summarylabel'>Total Length: </span>
            <span class='summaryvalue'>0</span>
        </span> &mdash; 
        <span class='maxele'>
            <span class='summarylabel'>Max Elevation: </span>
            <span class='summaryvalue'>0</span>
        </span>
		&mdash; <span class='minele'>
            <span class='summarylabel'>Min Elevation: </span>
            <span class='summaryvalue'>0</span>
        </span>
    </div>
	<script>
        var apiKey = 'u2gXrMQDPW5Zpr0pzCZppgxxbl48kkXc',
            serviceUrl = 'https://api.os.uk/maps/vector/v1/vts',
            repo = 'https://raw.githubusercontent.com/FraserChapman/gritstone100/main/';
		var opts = {
			map: {
                center: [41.4583, 12.7059],
                zoom: 5,
                markerZoomAnimation: false,
                zoomControl: false,
                almostOver: true,
                almostDistance: 50,
                almostSamplingPeriod: 125
			},
			zoomControl: {
				position: 'topleft',
			},
			elevationControl: {
				tracks: {
					track_1: {
						url: repo + 'gpx/gritstone100.gpx',
						color: '#3490dc'
					},
					track_2: {
						url: repo + 'gpx/bleaklow-bomber.gpx',
						color: '#f6993f'
					},
                    track_3: {
						url: repo + 'gpx/alport-ridge.gpx',
						color: '#f6993f'
					},
					track_4: {
						url: repo + 'gpx/missing-castleton.gpx',
						color: '#f6993f'
					},
                    track_5: {
						url: repo + 'gpx/grindsbrook-clough.gpx',
						color: '#3490dc'
					},
					track_6: {
						url: repo + 'gpx/swains-head.gpx',
						color: '#f6993f'
					}              
				},
				options: {
					position: 'bottomleft',
					theme: 'steelblue-theme', //default: lime-theme
					useHeightIndicator: true, //if false a marker is drawn at map position
					interpolation: d3.curveLinear, //see https://github.com/d3/d3/wiki/
					collapsed: false, //collapsed mode, show chart on click or mouseover
					detachedView: true,
				},
			},
			layersControl: {
				options: {
					collapsed: false,
				},
			},
		};

		var map = new L.Map('map', opts.map);

        L.mapboxGL({
            style: serviceUrl + '/resources/styles?key=' + apiKey,
            transformRequest: url => { return { url: url += '&srs=3857' } } 
          }).addTo(map);

		var controlZoom = new L.Control.Zoom(opts.zoomControl);
		var controlElevation = L.control.elevation(opts.elevationControl.options);
		var controlLayer = L.control.layers(null, null, opts.layersControl.options);

		controlZoom.addTo(map);
		controlLayer.addTo(map);
		controlElevation.loadChart(map);

		var traces = [];
		var tracks = opts.elevationControl.tracks;
		var i = 0;

		for (var track in tracks) {
			loadTrace(track, i++)
		}

		function loadTrace(track, i) {
			var trace = {};

			trace.gpx = new L.GPX(tracks[track].url, {
				async: true,
				index: i,
				marker_options: {
                    wptIconUrls: {
                        '': repo + 'icons/icon-small.png'
                    },
					startIconUrl: null,
					endIconUrl: null,
					shadowUrl: null,
				},
				polyline_options: {
					color: tracks[track].color,
				}
			});

			trace.gpx.on('loaded', function(e) {
				controlLayer.addBaseLayer(e.target, e.target.get_name());
				if (e.target.options.index == 0) {
					setElevationTrace(0);
				} else {
					map.removeLayer(e.target);
				}
			})

			trace.gpx.on('addline', function(e) {
				trace.line = e.line;
			})

			trace.gpx.addTo(map);
			traces.push(trace);
		}

		map.on('baselayerchange', function(e) {
			for (var i in traces) {
				if (traces[i].gpx._leaflet_id == e.layer._leaflet_id) {
					setElevationTrace(e.layer.options.index);
					break;
				}
			}
		});

		function setElevationTrace(index) {
			var trace = traces[index];
			controlElevation.clear();
			var q = document.querySelector.bind(document);
			controlElevation.addData(trace.line);
			map.fitBounds(trace.gpx.getBounds());
			trace.gpx.setStyle({
				color: 'blue',
				weight: 4,
				opacity: 0.8,
			});
			q('.totlen .summaryvalue').innerHTML = (trace.gpx.get_distance() / 1000).toFixed(2) + ' km';
			q('.maxele .summaryvalue').innerHTML = trace.gpx.get_elevation_max().toFixed(0) + ' m';
			q('.minele .summaryvalue').innerHTML = trace.gpx.get_elevation_min().toFixed(0) + ' m';
		}
	</script>

	<a href='https://github.com/Raruto/leaflet-elevation' class='view-on-github' style='position: fixed;top: 10px;left: calc(50% - 60px);z-index: 9999;'> <img alt='View on Github' src='https://raruto.github.io/img/view-on-github.png' title='View on Github'
		  width='163'> </a>

</body>

</html>
