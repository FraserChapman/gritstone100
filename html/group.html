<!DOCTYPE html>
<html>
<head>
  <title>group</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'>
  <meta name='viewport' content='initial-scale=1.0, user-scalable=no' />
  <link rel="stylesheet" href="https://labs.os.uk/public/os-api-branding/v0.2.0/os-api-branding.css" />
  <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/v1.13.1/mapbox-gl.css'/>
  <style>
    html,
    body,
    #map,
    #elevation-div {
      height: 100%;
      width: 100%;
      padding: 0px;
      margin: 0px;
    }
  </style>
  <script src="https://labs.os.uk/public/os-api-branding/v0.2.0/os-api-branding.js"></script>
  <script src='https://unpkg.com/leaflet@1.7.1/dist/leaflet.js'></script>
  <script src='https://unpkg.com/leaflet-ui@0.4.7/dist/leaflet-ui.js'></script>
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v1.13.1/mapbox-gl.js"></script>
  <style>
    .leaflet-control-attribution,
    .leaflet-control-scale { 
      display: none;
    }
    .leaflet-right .leaflet-control-layers-list {
      max-width: 250px;
      max-height: 25vh;
      overflow: auto;
    }
    .leaflet-tooltip {
      font-weight: 700;
    }
    #map {
      height: 75%;
    }
    #elevation-div {
      height: 25%;
      font: 12px/1.5 'Helvetica Neue', Arial, Helvetica, sans-serif;
    }
    .chart-placeholder {
      top: 20%;
      position: absolute;
      text-align: center;
      left: 0;
      right: 0;
      opacity: 0.5;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div id='map'></div>
  <div id='elevation-div' class='leaflet-control elevation'>
    <p class='chart-placeholder'>mouse over a track...</p>
  </div>
  <script>
    var apiKey = 'u2gXrMQDPW5Zpr0pzCZppgxxbl48kkXc',
      serviceUrl = 'https://api.os.uk/maps/vector/v1/vts',
      repo = 'https://raw.githubusercontent.com/FraserChapman/gritstone100/main/',
      opts = {
          map: {
              center: [41.4583, 12.7059],
              zoom: 5,
              mapTypeIds: [],
              fullscreenControl: false,
              searchControl: false,
              loadingControl: false,
              minimapControl: false,
              pegmanControl: false,
              almostOver: true,
              almostDistance: 50,
              almostSamplingPeriod: 125,
              plugins: [
                  'd3@4.13.0/build/d3.min.js',
                  'leaflet-gpx@1.5.0/gpx.js',
                  'leaflet-geometryutil@0.9.1/src/leaflet.geometryutil.js',
                  'leaflet-almostover@1.0.1/src/leaflet.almostover.js',
                  'mapbox-gl-leaflet@0.0.15/leaflet-mapbox-gl.js',
                  '@raruto/leaflet-elevation@1.5.0/dist/leaflet-elevation.min.css',
                  '@raruto/leaflet-elevation@1.5.0/dist/leaflet-elevation.min.js',
                  '@raruto/leaflet-elevation@1.5.0/libs/leaflet-distance-marker.min.css',
                  '@raruto/leaflet-elevation@1.5.0/libs/leaflet-distance-marker.min.js',
                  '@raruto/leaflet-elevation@1.5.0/libs/leaflet-gpxgroup.min.js'
              ],
          },
          tracks: [
              repo + 'gpx/gritstone100.gpx',
              repo + 'gpx/alport-ridge.gpx',
              repo + 'gpx/bleaklow-bomber.gpx',
              repo + 'gpx/missing-castleton.gpx',
              repo + 'gpx/grindsbrook-clough.gpx',
              repo + 'gpx/swains-head.gpx'
          ],
          points: {
            icon: {
              iconUrl: repo + 'icons/elevation-poi.png',
              iconSize: [12, 12],
            }
          },
          elevation: {
              detachedView: true,
              elevationDiv: '#elevation-div',
              followPositionMarker: true,
              zFollow: 15,
              legend: false,
          },
          markers: {
              wptIconUrls: {
                  '': null //repo + 'icons/icon-small.png'
              },
              startIconUrl: null,
              endIconUrl: null,
              shadowUrl: null,
          }
      };

  var map = L.map('map', opts.map);
  map.on('plugins_loaded', function(e) {
      map.on('eledata_added eledata_clear', function(e) {
          var p = document.querySelector('.chart-placeholder');
          p && (p.style.display = e.type == 'eledata_added' ? 'none' : '');
      });
      L.mapboxGL({
            style: serviceUrl + '/resources/styles?key=' + apiKey,
            transformRequest: url => { return { url: url += '&srs=3857' } } 
          }).addTo(map);

      d3.json(repo + 'json/poi.js', function(points) {
        console.log(points)
        L.gpxGroup(
          opts.tracks, 
          {
            // points: points,
            // points_options: opts.points,
            elevation: true,
            elevation_options: opts.elevation,
            marker_options: opts.markers,
            legend: true,
            distanceMarkers: false
          }
        ).addTo(map);
      });

  });  
  </script>
</body>
</html>